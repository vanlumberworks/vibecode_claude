<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forex Agent System - Live Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .content {
            padding: 30px;
        }

        .query-section {
            margin-bottom: 30px;
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }

        input[type="text"] {
            flex: 1;
            padding: 15px;
            font-size: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 15px 30px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .quick-queries {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .quick-query {
            padding: 8px 15px;
            background: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-query:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .status-section {
            background: #f9fafb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .progress-bar-container {
            background: #e5e7eb;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            width: 0%;
        }

        .stage-info {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 20px;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .agent-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.3s;
        }

        .agent-card.completed {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .agent-icon {
            font-size: 2rem;
        }

        .agent-info {
            flex: 1;
        }

        .agent-name {
            font-weight: 600;
            color: #1f2937;
        }

        .agent-status {
            font-size: 12px;
            color: #6b7280;
        }

        .decision-card {
            background: white;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
            padding: 25px;
            margin-top: 20px;
        }

        .decision-header {
            display: flex;
            align-items: center;
            gap: 15px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e5e7eb;
        }

        .decision-emoji {
            font-size: 3rem;
        }

        .decision-action {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .decision-confidence {
            color: #6b7280;
            margin: 5px 0 0;
        }

        .decision-section {
            margin-top: 20px;
        }

        .decision-section h3 {
            margin-bottom: 10px;
            color: #1f2937;
        }

        .key-factors {
            list-style: none;
        }

        .key-factors li {
            padding: 8px 0;
            border-bottom: 1px solid #f3f4f6;
        }

        .key-factors li:before {
            content: "‚ñ∏ ";
            color: #667eea;
            font-weight: bold;
        }

        .trade-params {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .param {
            background: #f9fafb;
            padding: 12px;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
        }

        .param-label {
            color: #6b7280;
            font-weight: 600;
        }

        .param-value {
            color: #1f2937;
            font-weight: 700;
        }

        .sources {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .source-link {
            color: #667eea;
            text-decoration: none;
            padding: 10px;
            background: #f9fafb;
            border-radius: 6px;
            transition: background 0.2s;
        }

        .source-link:hover {
            background: #f3f4f6;
            text-decoration: underline;
        }

        .error-message {
            background: #fef2f2;
            border: 2px solid #fecaca;
            color: #dc2626;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .hidden {
            display: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .analyzing {
            animation: pulse 1.5s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåç Forex Agent System</h1>
            <p>Real-time Multi-Agent Trading Analysis</p>
        </div>

        <div class="content">
            <!-- Query Input Section -->
            <div class="query-section">
                <div class="input-group">
                    <input
                        type="text"
                        id="queryInput"
                        placeholder="Enter query (e.g., 'Analyze gold trading', 'EUR/USD')"
                    />
                    <button class="btn-primary" id="analyzeBtn">Analyze</button>
                    <button class="btn-danger hidden" id="cancelBtn">Cancel</button>
                </div>

                <div class="quick-queries">
                    <span style="color: #6b7280; font-size: 14px;">Quick queries:</span>
                    <div class="quick-query" data-query="Analyze gold trading">Gold</div>
                    <div class="quick-query" data-query="EUR/USD">EUR/USD</div>
                    <div class="quick-query" data-query="Should I buy Bitcoin?">Bitcoin</div>
                    <div class="quick-query" data-query="GBP/USD analysis">GBP/USD</div>
                </div>
            </div>

            <!-- Error Message -->
            <div id="errorMessage" class="error-message hidden"></div>

            <!-- Status Section -->
            <div id="statusSection" class="status-section hidden">
                <div class="progress-bar-container">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <div class="stage-info" id="stageInfo">Initializing...</div>

                <div class="agents-grid" id="agentsGrid">
                    <div class="agent-card" id="newsAgent">
                        <div class="agent-icon">üì∞</div>
                        <div class="agent-info">
                            <div class="agent-name">News Agent</div>
                            <div class="agent-status">Waiting...</div>
                        </div>
                    </div>
                    <div class="agent-card" id="technicalAgent">
                        <div class="agent-icon">üìä</div>
                        <div class="agent-info">
                            <div class="agent-name">Technical Agent</div>
                            <div class="agent-status">Waiting...</div>
                        </div>
                    </div>
                    <div class="agent-card" id="fundamentalAgent">
                        <div class="agent-icon">üíº</div>
                        <div class="agent-info">
                            <div class="agent-name">Fundamental Agent</div>
                            <div class="agent-status">Waiting...</div>
                        </div>
                    </div>
                </div>

                <div id="riskStatus" class="hidden" style="margin-top: 15px;"></div>
            </div>

            <!-- Decision Card -->
            <div id="decisionCard" class="decision-card hidden"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:8000';
        let eventSource = null;

        // DOM elements
        const queryInput = document.getElementById('queryInput');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const errorMessage = document.getElementById('errorMessage');
        const statusSection = document.getElementById('statusSection');
        const progressBar = document.getElementById('progressBar');
        const stageInfo = document.getElementById('stageInfo');
        const decisionCard = document.getElementById('decisionCard');
        const riskStatus = document.getElementById('riskStatus');

        // Quick query buttons
        document.querySelectorAll('.quick-query').forEach(btn => {
            btn.addEventListener('click', () => {
                queryInput.value = btn.dataset.query;
                startAnalysis();
            });
        });

        // Analyze button
        analyzeBtn.addEventListener('click', startAnalysis);
        queryInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') startAnalysis();
        });

        // Cancel button
        cancelBtn.addEventListener('click', cancelAnalysis);

        function startAnalysis() {
            const query = queryInput.value.trim();
            if (!query) return;

            // Reset UI
            hideError();
            hideDecision();
            showStatus();

            // Update buttons
            analyzeBtn.classList.add('hidden');
            cancelBtn.classList.remove('hidden');
            queryInput.disabled = true;

            // Reset agents
            resetAgents();

            // Update progress
            setProgress(10, 'Starting analysis...');

            // Start streaming
            const url = `${API_URL}/analyze/stream?query=${encodeURIComponent(query)}`;
            eventSource = new EventSource(url);

            eventSource.addEventListener('start', handleStart);
            eventSource.addEventListener('query_parsed', handleQueryParsed);
            eventSource.addEventListener('agent_update', handleAgentUpdate);
            eventSource.addEventListener('risk_update', handleRiskUpdate);
            eventSource.addEventListener('decision', handleDecision);
            eventSource.addEventListener('complete', handleComplete);
            eventSource.addEventListener('error', handleError);
            eventSource.onerror = handleConnectionError;
        }

        function cancelAnalysis() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
            }
            resetUI();
        }

        function handleStart(event) {
            const data = JSON.parse(event.data);
            setProgress(20, 'Parsing query...');
        }

        function handleQueryParsed(event) {
            const data = JSON.parse(event.data);
            setProgress(30, `Analyzing ${data.pair}...`);
        }

        function handleAgentUpdate(event) {
            const data = JSON.parse(event.data);
            updateAgent(data.agent, 'completed');
            setProgress(30 + (data.step * 10), `${data.agent} agent completed`);
        }

        function handleRiskUpdate(event) {
            const data = JSON.parse(event.data);
            setProgress(70, 'Risk assessment complete');

            const approved = data.trade_approved;
            riskStatus.className = '';
            riskStatus.innerHTML = `
                <strong>‚öñÔ∏è Risk Assessment: ${approved ? '<span style="color: #10b981;">APPROVED ‚úì</span>' : '<span style="color: #ef4444;">REJECTED ‚úó</span>'}</strong>
                ${!approved ? `<div style="margin-top: 8px; font-size: 14px;">${data.risk_result.data.rejection_reason}</div>` : ''}
            `;
            riskStatus.classList.remove('hidden');

            if (approved) {
                setProgress(80, 'Synthesizing final decision...');
            }
        }

        function handleDecision(event) {
            const data = JSON.parse(event.data);
            setProgress(90, 'Decision made');
        }

        function handleComplete(event) {
            const data = JSON.parse(event.data);
            setProgress(100, 'Complete!');
            displayDecision(data.result.decision);
            resetUI();
            eventSource.close();
        }

        function handleError(event) {
            const data = JSON.parse(event.data);
            showError(data.error);
            resetUI();
            eventSource.close();
        }

        function handleConnectionError(error) {
            console.error('Connection error:', error);
            showError('Connection to server lost. Please check if the API server is running.');
            resetUI();
        }

        function updateAgent(agentName, status) {
            const agentMap = {
                'news': 'newsAgent',
                'technical': 'technicalAgent',
                'fundamental': 'fundamentalAgent'
            };

            const agentId = agentMap[agentName];
            if (!agentId) return;

            const agentCard = document.getElementById(agentId);
            const statusEl = agentCard.querySelector('.agent-status');

            if (status === 'completed') {
                agentCard.classList.add('completed');
                statusEl.textContent = 'Completed ‚úì';
            }
        }

        function displayDecision(decision) {
            if (!decision) return;

            const actionColors = {
                'BUY': '#10b981',
                'SELL': '#ef4444',
                'WAIT': '#f59e0b'
            };

            const actionEmojis = {
                'BUY': 'üü¢',
                'SELL': 'üî¥',
                'WAIT': 'üü°'
            };

            let html = `
                <div class="decision-header" style="border-left: 4px solid ${actionColors[decision.action]}">
                    <div class="decision-emoji">${actionEmojis[decision.action]}</div>
                    <div>
                        <h2 class="decision-action">${decision.action}</h2>
                        <p class="decision-confidence">Confidence: ${(decision.confidence * 100).toFixed(0)}%</p>
                    </div>
                </div>
            `;

            if (decision.reasoning?.summary) {
                html += `
                    <div class="decision-section">
                        <h3>Summary</h3>
                        <p>${decision.reasoning.summary}</p>
                    </div>
                `;
            }

            if (decision.reasoning?.key_factors?.length > 0) {
                html += `
                    <div class="decision-section">
                        <h3>Key Factors</h3>
                        <ul class="key-factors">
                            ${decision.reasoning.key_factors.map(f => `<li>${f}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }

            if (decision.trade_parameters && decision.action !== 'WAIT') {
                html += `
                    <div class="decision-section">
                        <h3>Trade Parameters</h3>
                        <div class="trade-params">
                            <div class="param">
                                <span class="param-label">Entry:</span>
                                <span class="param-value">${decision.trade_parameters.entry_price}</span>
                            </div>
                            <div class="param">
                                <span class="param-label">Stop Loss:</span>
                                <span class="param-value">${decision.trade_parameters.stop_loss}</span>
                            </div>
                            <div class="param">
                                <span class="param-label">Take Profit:</span>
                                <span class="param-value">${decision.trade_parameters.take_profit}</span>
                            </div>
                            <div class="param">
                                <span class="param-label">Position Size:</span>
                                <span class="param-value">${decision.trade_parameters.position_size} lots</span>
                            </div>
                        </div>
                    </div>
                `;
            }

            if (decision.grounding_metadata?.sources?.length > 0) {
                html += `
                    <div class="decision-section">
                        <h3>üåê Sources (${decision.grounding_metadata.sources.length})</h3>
                        <div class="sources">
                            ${decision.grounding_metadata.sources.slice(0, 5).map((s, i) =>
                                `<a href="${s.url}" target="_blank" class="source-link">${i+1}. ${s.title}</a>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }

            decisionCard.innerHTML = html;
            decisionCard.classList.remove('hidden');
        }

        function setProgress(percent, text) {
            progressBar.style.width = `${percent}%`;
            stageInfo.textContent = text;
        }

        function showStatus() {
            statusSection.classList.remove('hidden');
        }

        function hideStatus() {
            statusSection.classList.add('hidden');
        }

        function showError(message) {
            errorMessage.textContent = `‚ùå ${message}`;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        function hideDecision() {
            decisionCard.classList.add('hidden');
        }

        function resetAgents() {
            ['newsAgent', 'technicalAgent', 'fundamentalAgent'].forEach(id => {
                const card = document.getElementById(id);
                card.classList.remove('completed');
                card.querySelector('.agent-status').textContent = 'Waiting...';
            });
            riskStatus.classList.add('hidden');
        }

        function resetUI() {
            analyzeBtn.classList.remove('hidden');
            cancelBtn.classList.add('hidden');
            queryInput.disabled = false;
        }

        // Check if server is running on load
        fetch(`${API_URL}/health`)
            .then(res => res.json())
            .then(data => console.log('‚úì API server is running:', data))
            .catch(err => {
                showError('Could not connect to API server. Please start it with: python backend/server.py');
            });
    </script>
</body>
</html>
